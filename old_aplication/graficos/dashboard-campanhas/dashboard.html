<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Campanhas - Metabase + ECharts</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            margin: 0;
            color: #333;
            font-size: 24px;
        }
        .info {
            color: #666;
            margin-top: 10px;
        }
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .control-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        button:hover {
            background: #357ae8;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        #main-chart {
            width: 100%;
            height: 800px;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .metric-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4285f4;
        }
        .metric-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .tooltip-formatter {
            padding: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            border-radius: 4px;
        }
        #data-input {
            width: 100%;
            margin-bottom: 10px;
        }
        .legend-scroll {
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Dashboard de Campanhas de Marketing</h1>
            <div class="info">
                An√°lise multi-dimensional com barras empilhadas e m√©tricas calculadas
            </div>
        </div>
        
        <div class="controls">
            <div class="control-group" style="margin-bottom: 15px;">
                <button onclick="loadMetabaseData()">üì• Carregar Dados do Metabase</button>
                <button onclick="loadSampleData()">üé≤ Carregar Dados de Exemplo</button>
                <button onclick="exportChart()">üíæ Exportar Gr√°fico</button>
            </div>
            
            <div class="control-group">
                <label>M√©tricas em Barras:</label>
                <select id="barMetrics" multiple size="4" style="width: 200px;">
                    <option value="impressions" selected>Impressions</option>
                    <option value="clicks" selected>Clicks</option>
                    <option value="spend" selected>Spend</option>
                    <option value="conversions" selected>Conversions</option>
                </select>
                
                <label style="margin-left: 20px;">M√©tricas em Linhas:</label>
                <select id="lineMetrics" multiple size="6" style="width: 200px;">
                    <option value="cpm" selected>CPM</option>
                    <option value="ctr" selected>CTR %</option>
                    <option value="cpc" selected>CPC</option>
                    <option value="convRate" selected>ConvRate %</option>
                    <option value="cpConv" selected>CPConv</option>
                    <option value="roas" selected>ROAS</option>
                </select>
                
                <button onclick="updateChart()">üîÑ Atualizar Gr√°fico</button>
            </div>
        </div>
        
        <div class="metrics-grid" id="metricsGrid">
            <!-- M√©tricas ser√£o inseridas aqui -->
        </div>
        
        <div class="chart-container">
            <div id="main-chart"></div>
        </div>
    </div>

    <script>
        // Inicializar o gr√°fico
        const chartDom = document.getElementById('main-chart');
        const myChart = echarts.init(chartDom);
        
        let rawData = [];
        let processedData = {};
        
        // Fun√ß√£o para processar dados do Metabase
        function processMetabaseData(data) {
            // Agrupar dados por data e campaign
            const groupedData = {};
            const campaigns = new Set();
            const dates = new Set();
            
            data.forEach(row => {
                const date = row.date;
                const campaign = row.campaign_name;
                
                dates.add(date);
                campaigns.add(campaign);
                
                if (!groupedData[date]) {
                    groupedData[date] = {};
                }
                
                if (!groupedData[date][campaign]) {
                    groupedData[date][campaign] = {
                        impressions: 0,
                        clicks: 0,
                        spend: 0,
                        conversions: 0,
                        revenue: row.revenue || 0
                    };
                }
                
                groupedData[date][campaign].impressions += row.impressions || 0;
                groupedData[date][campaign].clicks += row.clicks || 0;
                groupedData[date][campaign].spend += row.spend || 0;
                groupedData[date][campaign].conversions += row.conversions || 0;
                groupedData[date][campaign].revenue += row.revenue || 0;
            });
            
            // Ordenar datas
            const sortedDates = Array.from(dates).sort();
            const campaignsList = Array.from(campaigns).sort();
            
            // Preparar dados para o gr√°fico
            const seriesData = {
                dates: sortedDates,
                campaigns: campaignsList,
                impressions: {},
                clicks: {},
                spend: {},
                conversions: {},
                // M√©tricas calculadas
                cpm: [],
                ctr: [],
                cpc: [],
                convRate: [],
                cpConv: [],
                roas: []
            };
            
            // Inicializar arrays para cada campanha
            campaignsList.forEach(campaign => {
                seriesData.impressions[campaign] = [];
                seriesData.clicks[campaign] = [];
                seriesData.spend[campaign] = [];
                seriesData.conversions[campaign] = [];
            });
            
            // Preencher dados e calcular m√©tricas
            sortedDates.forEach(date => {
                let totalImpressions = 0;
                let totalClicks = 0;
                let totalSpend = 0;
                let totalConversions = 0;
                let totalRevenue = 0;
                
                campaignsList.forEach(campaign => {
                    const data = groupedData[date] && groupedData[date][campaign] || {};
                    
                    seriesData.impressions[campaign].push(data.impressions || 0);
                    seriesData.clicks[campaign].push(data.clicks || 0);
                    seriesData.spend[campaign].push(data.spend || 0);
                    seriesData.conversions[campaign].push(data.conversions || 0);
                    
                    totalImpressions += data.impressions || 0;
                    totalClicks += data.clicks || 0;
                    totalSpend += data.spend || 0;
                    totalConversions += data.conversions || 0;
                    totalRevenue += data.revenue || 0;
                });
                
                // Calcular m√©tricas (com prote√ß√£o contra divis√£o por zero)
                seriesData.cpm.push(totalImpressions > 0 ? (totalSpend / (totalImpressions / 1000)) : null);
                seriesData.ctr.push(totalImpressions > 0 ? (totalClicks / totalImpressions * 100) : null);
                seriesData.cpc.push(totalClicks > 0 ? (totalSpend / totalClicks) : null);
                seriesData.convRate.push(totalClicks > 0 ? (totalConversions / totalClicks * 100) : null);
                seriesData.cpConv.push(totalConversions > 0 ? (totalSpend / totalConversions) : null);
                seriesData.roas.push(totalSpend > 0 ? ((totalRevenue / totalSpend) * 100) : null);
            });
            
            return seriesData;
        }
        
        // Fun√ß√£o para criar o gr√°fico
        function createChart(data) {
            const colors = [
                '#5470c6', '#91cc75', '#fac858', '#ee6666', '#73c0de',
                '#3ba272', '#fc8452', '#9a60b4', '#ea7ccc', '#ff9a00'
            ];
            
            // Configurar s√©ries de barras empilhadas
            const barSeries = [];
            const selectedBarMetrics = Array.from(document.getElementById('barMetrics').selectedOptions)
                .map(option => option.value);
            
            selectedBarMetrics.forEach((metric, metricIndex) => {
                data.campaigns.forEach((campaign, campaignIndex) => {
                    barSeries.push({
                        name: `${campaign} - ${metric}`,
                        type: 'bar',
                        stack: metric,
                        emphasis: {
                            focus: 'series'
                        },
                        yAxisIndex: metricIndex,
                        data: data[metric][campaign],
                        itemStyle: {
                            color: colors[campaignIndex % colors.length]
                        }
                    });
                });
            });
            
            // Configurar s√©ries de linhas
            const lineSeries = [];
            const selectedLineMetrics = Array.from(document.getElementById('lineMetrics').selectedOptions)
                .map(option => option.value);
            
            const lineMetricConfig = {
                cpm: { name: 'CPM', yAxisIndex: 4, color: '#ff7875' },
                ctr: { name: 'CTR %', yAxisIndex: 5, color: '#95de64' },
                cpc: { name: 'CPC', yAxisIndex: 6, color: '#ffd666' },
                convRate: { name: 'ConvRate %', yAxisIndex: 7, color: '#5cdbd3' },
                cpConv: { name: 'CPConv', yAxisIndex: 8, color: '#b37feb' },
                roas: { name: 'ROAS', yAxisIndex: 9, color: '#ff85c0' }
            };
            
            selectedLineMetrics.forEach(metric => {
                const config = lineMetricConfig[metric];
                lineSeries.push({
                    name: config.name,
                    type: 'line',
                    yAxisIndex: config.yAxisIndex,
                    data: data[metric],
                    smooth: true,
                    symbol: 'circle',
                    symbolSize: 6,
                    lineStyle: {
                        width: 3,
                        color: config.color
                    },
                    itemStyle: {
                        color: config.color
                    },
                    emphasis: {
                        scale: 1.5
                    }
                });
            });
            
            // Configurar eixos Y
            const yAxisConfig = [
                { type: 'value', name: 'Impressions', position: 'left' },
                { type: 'value', name: 'Clicks', position: 'left', offset: 60 },
                { type: 'value', name: 'Spend ($)', position: 'left', offset: 120 },
                { type: 'value', name: 'Conversions', position: 'left', offset: 180 },
                { type: 'value', name: 'CPM ($)', position: 'right' },
                { type: 'value', name: 'CTR (%)', position: 'right', offset: 60 },
                { type: 'value', name: 'CPC ($)', position: 'right', offset: 120 },
                { type: 'value', name: 'ConvRate (%)', position: 'right', offset: 180 },
                { type: 'value', name: 'CPConv ($)', position: 'right', offset: 240 },
                { type: 'value', name: 'ROAS (%)', position: 'right', offset: 300 }
            ];
            
            // Configura√ß√£o do gr√°fico
            const option = {
                title: {
                    text: 'Dashboard de Performance de Campanhas',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    },
                    formatter: function(params) {
                        let html = `<div style="padding: 10px;"><strong>${params[0].axisValue}</strong><br/>`;
                        
                        // Agrupar por m√©trica
                        const grouped = {};
                        params.forEach(param => {
                            const [campaign, metric] = param.seriesName.split(' - ');
                            if (!grouped[metric || param.seriesName]) {
                                grouped[metric || param.seriesName] = [];
                            }
                            grouped[metric || param.seriesName].push(param);
                        });
                        
                        Object.entries(grouped).forEach(([metric, items]) => {
                            html += `<br/><strong>${metric}:</strong><br/>`;
                            items.forEach(item => {
                                const value = item.value !== null ? item.value.toFixed(2) : 'N/A';
                                html += `${item.marker} ${item.seriesName}: ${value}<br/>`;
                            });
                        });
                        
                        html += '</div>';
                        return html;
                    }
                },
                toolbox: {
                    feature: {
                        dataZoom: { show: true },
                        dataView: { show: true, readOnly: false },
                        magicType: { show: true, type: ['line', 'bar', 'stack'] },
                        restore: { show: true },
                        saveAsImage: { show: true }
                    }
                },
                legend: {
                    type: 'scroll',
                    orient: 'horizontal',
                    bottom: 0,
                    data: [...barSeries, ...lineSeries].map(s => s.name)
                },
                grid: {
                    left: 250,
                    right: 350,
                    bottom: 100,
                    containLabel: false
                },
                dataZoom: [
                    {
                        type: 'slider',
                        show: true,
                        xAxisIndex: [0],
                        start: 0,
                        end: 100,
                        bottom: 60
                    },
                    {
                        type: 'inside',
                        xAxisIndex: [0],
                        start: 0,
                        end: 100
                    }
                ],
                xAxis: {
                    type: 'category',
                    boundaryGap: true,
                    data: data.dates,
                    axisLabel: {
                        rotate: 45,
                        formatter: function(value) {
                            return value.split('T')[0]; // Formatar data
                        }
                    }
                },
                yAxis: yAxisConfig,
                series: [...barSeries, ...lineSeries]
            };
            
            myChart.setOption(option, true);
            updateMetrics(data);
        }
        
        // Fun√ß√£o para atualizar m√©tricas resumidas
        function updateMetrics(data) {
            const metricsGrid = document.getElementById('metricsGrid');
            
            // Calcular totais
            let totalImpressions = 0;
            let totalClicks = 0;
            let totalSpend = 0;
            let totalConversions = 0;
            
            data.campaigns.forEach(campaign => {
                totalImpressions += data.impressions[campaign].reduce((a, b) => a + b, 0);
                totalClicks += data.clicks[campaign].reduce((a, b) => a + b, 0);
                totalSpend += data.spend[campaign].reduce((a, b) => a + b, 0);
                totalConversions += data.conversions[campaign].reduce((a, b) => a + b, 0);
            });
            
            const avgCPM = data.cpm.filter(v => v !== null).reduce((a, b) => a + b, 0) / data.cpm.filter(v => v !== null).length;
            const avgCTR = data.ctr.filter(v => v !== null).reduce((a, b) => a + b, 0) / data.ctr.filter(v => v !== null).length;
            const avgCPC = data.cpc.filter(v => v !== null).reduce((a, b) => a + b, 0) / data.cpc.filter(v => v !== null).length;
            const avgROAS = data.roas.filter(v => v !== null).reduce((a, b) => a + b, 0) / data.roas.filter(v => v !== null).length;
            
            metricsGrid.innerHTML = `
                <div class="metric-card">
                    <div class="metric-title">Total Impress√µes</div>
                    <div class="metric-value">${totalImpressions.toLocaleString()}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Total Cliques</div>
                    <div class="metric-value">${totalClicks.toLocaleString()}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Total Gasto</div>
                    <div class="metric-value">$${totalSpend.toFixed(2)}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Total Convers√µes</div>
                    <div class="metric-value">${totalConversions.toLocaleString()}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">CPM M√©dio</div>
                    <div class="metric-value">$${avgCPM.toFixed(2)}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">CTR M√©dio</div>
                    <div class="metric-value">${avgCTR.toFixed(2)}%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">CPC M√©dio</div>
                    <div class="metric-value">$${avgCPC.toFixed(2)}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">ROAS M√©dio</div>
                    <div class="metric-value">${avgROAS.toFixed(2)}%</div>
                </div>
            `;
        }
        
        // Fun√ß√£o para carregar dados do Metabase
        function loadMetabaseData() {
            if (window.metabaseDados && window.metabaseDados.formatted) {
                rawData = window.metabaseDados.formatted;
                processedData = processMetabaseData(rawData);
                createChart(processedData);
            } else {
                alert('Por favor, carregue os dados do Metabase primeiro usando a API!');
            }
        }
        
        // Fun√ß√£o para carregar dados de exemplo
        function loadSampleData() {
            const campaigns = ['Google Ads', 'Facebook Ads', 'Instagram', 'LinkedIn'];
            const dates = [];
            const sampleData = [];
            
            // Gerar 30 dias de dados
            for (let i = 0; i < 30; i++) {
                const date = new Date();
                date.setDate(date.getDate() - (30 - i));
                const dateStr = date.toISOString().split('T')[0];
                dates.push(dateStr);
                
                campaigns.forEach(campaign => {
                    sampleData.push({
                        date: dateStr,
                        campaign_name: campaign,
                        impressions: Math.floor(Math.random() * 50000) + 10000,
                        clicks: Math.floor(Math.random() * 1000) + 100,
                        spend: Math.random() * 500 + 100,
                        conversions: Math.floor(Math.random() * 50) + 5,
                        revenue: Math.random() * 2000 + 500
                    });
                });
            }
            
            rawData = sampleData;
            processedData = processMetabaseData(rawData);
            createChart(processedData);
        }
        
        // Fun√ß√£o para atualizar o gr√°fico
        function updateChart() {
            if (processedData.dates) {
                createChart(processedData);
            } else {
                alert('Por favor, carregue os dados primeiro!');
            }
        }
        
        // Fun√ß√£o para exportar o gr√°fico
        function exportChart() {
            const url = myChart.getDataURL({
                type: 'png',
                pixelRatio: 2,
                backgroundColor: '#fff'
            });
            
            const link = document.createElement('a');
            link.download = 'dashboard-campanhas.png';
            link.href = url;
            link.click();
        }
        
        // Responsividade
        window.addEventListener('resize', function() {
            myChart.resize();
        });
        
        // Carregar dados de exemplo ao iniciar
        loadSampleData();
    </script>
</body>
</html>
