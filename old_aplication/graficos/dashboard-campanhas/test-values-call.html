<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Teste - Chamar Fun√ß√£o values()</title>
    <style>
        body { font-family: Arial; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        button { background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #5a67d8; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background: #e8f5e9; color: #2e7d32; }
        .error { background: #ffebee; color: #c62828; }
        .info { background: #e3f2fd; color: #1565c0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Teste - Como Chamar values()</h1>
        
        <div class="result info">
            Este teste descobre como acessar os valores reais quando values √© uma fun√ß√£o.
        </div>
        
        <button onclick="testAllWidgets()">Testar Todos os Widgets</button>
        <button onclick="testSpecificWidget(1)">Testar Widget Conta</button>
        <button onclick="deepInvestigation()">Investiga√ß√£o Profunda</button>
        
        <h2>Resultados:</h2>
        <pre id="results"></pre>
    </div>

    <script>
        function log(message, data) {
            const results = document.getElementById('results');
            results.textContent += message + '\n';
            if (data !== undefined) {
                results.textContent += JSON.stringify(data, null, 2) + '\n';
            }
            results.textContent += '\n';
        }

        function testAllWidgets() {
            if (window.parent === window) {
                log('‚ùå N√£o est√° em iframe!');
                return;
            }
            
            const widgets = window.parent.document.querySelectorAll('[data-testid*="parameter-value-widget"]');
            log(`Encontrados ${widgets.length} widgets\n`);
            
            widgets.forEach((widget, index) => {
                log(`=== Widget ${index} ===`);
                log('Texto:', widget.textContent?.trim());
                
                // Buscar React
                const reactKeys = Object.keys(widget).filter(k => k.includes('react'));
                if (reactKeys.length > 0) {
                    const fiber = widget[reactKeys[0]];
                    
                    // Tentar diferentes formas de chamar values
                    if (fiber && fiber.memoizedProps) {
                        // M√©todo 1: Chamar diretamente
                        if (typeof fiber.memoizedProps.values === 'function') {
                            try {
                                const result = fiber.memoizedProps.values();
                                log('‚úÖ values() direto:', result);
                            } catch (e) {
                                log('‚ùå Erro ao chamar values():', e.message);
                                
                                // M√©todo 2: Chamar com bind
                                try {
                                    const boundValues = fiber.memoizedProps.values.bind(fiber.memoizedProps);
                                    const result = boundValues();
                                    log('‚úÖ values() com bind:', result);
                                } catch (e2) {
                                    log('‚ùå Erro com bind:', e2.message);
                                }
                            }
                        }
                        
                        // Verificar outras props
                        const interestingProps = ['value', 'selectedValue', 'selectedValues', 'defaultValue'];
                        interestingProps.forEach(prop => {
                            if (fiber.memoizedProps[prop] !== undefined) {
                                const val = fiber.memoizedProps[prop];
                                if (typeof val === 'function') {
                                    log(`${prop} √© fun√ß√£o`);
                                } else {
                                    log(`${prop}:`, val);
                                }
                            }
                        });
                    }
                }
                
                log('---\n');
            });
        }

        function testSpecificWidget(index) {
            const widget = window.parent.document.querySelectorAll('[data-testid*="parameter-value-widget"]')[index];
            if (!widget) {
                log('Widget n√£o encontrado');
                return;
            }
            
            log(`Testando widget ${index}: ${widget.textContent?.trim()}\n`);
            
            // An√°lise profunda
            const reactKey = Object.keys(widget).find(k => k.includes('react'));
            if (!reactKey) {
                log('React n√£o encontrado');
                return;
            }
            
            const fiber = widget[reactKey];
            log('Fiber encontrado:', fiber);
            
            // Analisar toda a cadeia
            let current = fiber;
            let depth = 0;
            
            while (current && depth < 10) {
                log(`\nN√≠vel ${depth}:`);
                
                if (current.memoizedProps) {
                    Object.keys(current.memoizedProps).forEach(key => {
                        const value = current.memoizedProps[key];
                        if (typeof value === 'function') {
                            log(`- ${key}: [Function]`);
                            
                            // Tentar executar se parecer relevante
                            if (key.includes('value') || key === 'values') {
                                try {
                                    // Tentar diferentes contextos
                                    const contexts = [
                                        () => value(),
                                        () => value.call(current.memoizedProps),
                                        () => value.call(current),
                                        () => value.apply(current.memoizedProps, [])
                                    ];
                                    
                                    for (let i = 0; i < contexts.length; i++) {
                                        try {
                                            const result = contexts[i]();
                                            if (result !== undefined && result !== null) {
                                                log(`  ‚úÖ Contexto ${i} funcionou:`, result);
                                                break;
                                            }
                                        } catch (e) {
                                            // Continuar tentando
                                        }
                                    }
                                } catch (e) {
                                    log(`  ‚ùå N√£o foi poss√≠vel executar`);
                                }
                            }
                        } else if (value !== null && typeof value === 'object') {
                            log(`- ${key}: [Object]`);
                        } else {
                            log(`- ${key}:`, value);
                        }
                    });
                }
                
                current = current.return;
                depth++;
            }
        }

        function deepInvestigation() {
            log('üî¨ Investiga√ß√£o Profunda\n');
            
            // Tentar acessar o estado global do Metabase
            try {
                // Poss√≠veis locais onde o Metabase guarda estado
                const possiblePaths = [
                    'window.parent.app',
                    'window.parent.store',
                    'window.parent.__store',
                    'window.parent.MetabaseStore',
                    'window.parent.reduxStore'
                ];
                
                possiblePaths.forEach(path => {
                    try {
                        const obj = eval(path);
                        if (obj) {
                            log(`‚úÖ Encontrado: ${path}`);
                            
                            // Se tiver getState
                            if (typeof obj.getState === 'function') {
                                const state = obj.getState();
                                if (state.dashboard && state.dashboard.parameterValues) {
                                    log('Valores dos par√¢metros:', state.dashboard.parameterValues);
                                }
                            }
                        }
                    } catch (e) {
                        // Ignorar
                    }
                });
                
                // Tentar encontrar componentes React espec√≠ficos
                const allElements = window.parent.document.querySelectorAll('*');
                let foundComponents = 0;
                
                allElements.forEach(el => {
                    const reactKey = Object.keys(el).find(k => k.includes('react'));
                    if (reactKey) {
                        const fiber = el[reactKey];
                        if (fiber && fiber.elementType && fiber.elementType.name) {
                            const name = fiber.elementType.name;
                            if (name.includes('Parameter') || name.includes('Filter')) {
                                foundComponents++;
                                log(`Componente encontrado: ${name}`);
                                
                                // Verificar props
                                if (fiber.memoizedProps && fiber.memoizedProps.parameter) {
                                    log('Par√¢metro:', fiber.memoizedProps.parameter);
                                }
                            }
                        }
                    }
                });
                
                log(`\nTotal de componentes de filtro encontrados: ${foundComponents}`);
                
            } catch (error) {
                log('Erro na investiga√ß√£o:', error.message);
            }
        }

        // Auto-executar se estiver em iframe
        if (window.parent !== window) {
            setTimeout(() => {
                log('üöÄ Teste iniciado automaticamente\n');
                testAllWidgets();
            }, 1000);
        }
    </script>
</body>
</html>
