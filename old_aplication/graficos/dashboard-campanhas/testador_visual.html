<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testador Visual - Dashboard Metabase</title>
    <style>
        * { box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f0f2f5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: #1a73e8;
            margin-bottom: 30px;
            text-align: center;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .card h2 {
            margin-top: 0;
            color: #202124;
            font-size: 18px;
            border-bottom: 2px solid #1a73e8;
            padding-bottom: 10px;
        }

        .status {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-size: 14px;
        }

        .status.ok {
            background: #e6f4ea;
            color: #1e8e3e;
        }

        .status.error {
            background: #fce8e6;
            color: #d33b27;
        }

        .status.warning {
            background: #fef7e0;
            color: #ea8600;
        }

        .status-icon {
            margin-right: 10px;
            font-size: 18px;
        }

        button {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }

        button:hover {
            background: #1557b0;
        }

        button:disabled {
            background: #dadce0;
            cursor: not-allowed;
        }

        .console {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .filter-builder {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .filter-row {
            display: grid;
            grid-template-columns: 1fr 2fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        input, select {
            padding: 8px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            font-size: 14px;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .results-table th {
            background: #f8f9fa;
            padding: 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dadce0;
        }

        .results-table td {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .step {
            background: #e8f0fe;
            border-left: 4px solid #1a73e8;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .step-number {
            display: inline-block;
            background: #1a73e8;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            margin-right: 10px;
            font-weight: bold;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1a73e8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #dadce0;
            margin-bottom: 20px;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            color: #5f6368;
            font-size: 14px;
            border-bottom: 3px solid transparent;
            margin: 0;
            border-radius: 0;
        }

        .tab-button.active {
            color: #1a73e8;
            border-bottom-color: #1a73e8;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .success-message {
            background: #e6f4ea;
            color: #1e8e3e;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            text-align: center;
            font-weight: 500;
        }

        .error-message {
            background: #fce8e6;
            color: #d33b27;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Testador Visual - Dashboard Metabase</h1>

        <div class="tab-buttons">
            <button class="tab-button active" onclick="showTab('status')">Status do Sistema</button>
            <button class="tab-button" onclick="showTab('test')">Testes R√°pidos</button>
            <button class="tab-button" onclick="showTab('filters')">Construtor de Filtros</button>
            <button class="tab-button" onclick="showTab('guide')">Guia Passo a Passo</button>
        </div>

        <!-- Tab 1: Status -->
        <div id="status-tab" class="tab-content active">
            <div class="grid">
                <div class="card">
                    <h2>üîå Conex√µes</h2>
                    <div id="connection-status"></div>
                    <button onclick="checkAllConnections()">Verificar Todas</button>
                </div>

                <div class="card">
                    <h2>üìã Configura√ß√µes</h2>
                    <div id="config-status"></div>
                    <button onclick="checkConfiguration()">Verificar Config</button>
                </div>
            </div>

            <div class="card">
                <h2>üñ•Ô∏è Console</h2>
                <div id="console" class="console">Aguardando comandos...</div>
            </div>
        </div>

        <!-- Tab 2: Testes -->
        <div id="test-tab" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2>üöÄ Testes R√°pidos</h2>
                    <button onclick="testProxyConnection()">1. Testar Proxy</button>
                    <button onclick="testQuestionInfo()">2. Info da Pergunta</button>
                    <button onclick="testSimpleQuery()">3. Query Simples</button>
                    <button onclick="testWithFilters()">4. Query com Filtros</button>
                    <div id="test-results" style="margin-top: 15px;"></div>
                </div>

                <div class="card">
                    <h2>üìä Resultados</h2>
                    <div id="query-results">
                        <p>Execute um teste para ver os resultados</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: Filtros -->
        <div id="filters-tab" class="tab-content">
            <div class="card">
                <h2>üîß Construtor de Filtros</h2>
                
                <div class="filter-builder">
                    <div id="filter-rows">
                        <div class="filter-row">
                            <select class="filter-field">
                                <option value="data">Data</option>
                                <option value="conta">Conta</option>
                                <option value="campanha">Campanha</option>
                                <option value="plataforma">Plataforma</option>
                                <option value="device">Dispositivo</option>
                            </select>
                            <input type="text" class="filter-value" placeholder="Valor (ex: past7days)">
                            <button onclick="removeFilterRow(this)">‚úñ</button>
                        </div>
                    </div>
                    <button onclick="addFilterRow()">+ Adicionar Filtro</button>
                    <button onclick="buildAndTest()">Testar Filtros</button>
                </div>

                <div id="filter-results" style="margin-top: 20px;"></div>
            </div>
        </div>

        <!-- Tab 4: Guia -->
        <div id="guide-tab" class="tab-content">
            <div class="card">
                <h2>üìö Guia Passo a Passo</h2>
                
                <div class="step">
                    <span class="step-number">1</span>
                    <strong>Verificar Proxy</strong>
                    <p>O proxy precisa estar rodando na porta 8091 com credenciais v√°lidas.</p>
                    <button onclick="testProxyConnection()">Testar Proxy</button>
                </div>

                <div class="step">
                    <span class="step-number">2</span>
                    <strong>Verificar Pergunta</strong>
                    <p>A pergunta (ID 51) deve existir e ter template tags configuradas.</p>
                    <button onclick="testQuestionInfo()">Verificar Pergunta</button>
                </div>

                <div class="step">
                    <span class="step-number">3</span>
                    <strong>Testar Query</strong>
                    <p>Execute uma query simples para verificar se os dados retornam.</p>
                    <button onclick="testSimpleQuery()">Executar Query</button>
                </div>

                <div class="step">
                    <span class="step-number">4</span>
                    <strong>Integrar no Dashboard</strong>
                    <p>Adicione o iframe no dashboard do Metabase:</p>
                    <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px;">&lt;iframe src="/graficos/dashboard-campanhas/index.html" 
        width="100%" height="600" style="border: none;"&gt;&lt;/iframe&gt;</pre>
                </div>
            </div>
        </div>
    </div>

    <script src="/static-api/api_config.js"></script>
    <script src="/static-api/metabase-api.js"></script>

    <script>
        // Estado
        const state = {
            api: null,
            questionId: window.CONFIG?.defaultQuestionId || 51
        };

        // Fun√ß√£o de log
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const time = new Date().toLocaleTimeString('pt-BR');
            const color = {
                info: '#9cdcfe',
                success: '#4ec9b0',
                error: '#f48771',
                warning: '#dcdcaa'
            }[type] || '#d4d4d4';
            
            console.innerHTML = `<span style="color: ${color}">[${time}] ${message}</span>\n` + console.innerHTML;
            
            // Limitar tamanho
            const lines = console.innerHTML.split('\n');
            if (lines.length > 50) {
                console.innerHTML = lines.slice(0, 50).join('\n');
            }
        }

        // Mostrar tab
        function showTab(tabName) {
            // Esconder todas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar selecionada
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');
        }

        // Verificar todas as conex√µes
        async function checkAllConnections() {
            const statusDiv = document.getElementById('connection-status');
            statusDiv.innerHTML = '<div class="loading"></div> Verificando...';
            
            const checks = [
                { name: 'Proxy (8091)', url: 'http://localhost:8091/test' },
                { name: 'Nginx (8080)', url: 'http://localhost:8080' },
                { name: 'API Config', url: '/static-api/api_config.js' },
                { name: 'Metabase API', url: '/static-api/metabase-api.js' }
            ];
            
            statusDiv.innerHTML = '';
            
            for (const check of checks) {
                try {
                    const response = await fetch(check.url);
                    const status = response.ok ? 'ok' : 'error';
                    const icon = response.ok ? '‚úÖ' : '‚ùå';
                    const message = response.ok ? 'Online' : `Erro ${response.status}`;
                    
                    statusDiv.innerHTML += `
                        <div class="status ${status}">
                            <span class="status-icon">${icon}</span>
                            ${check.name}: ${message}
                        </div>
                    `;
                    
                    log(`${check.name}: ${message}`, response.ok ? 'success' : 'error');
                } catch (error) {
                    statusDiv.innerHTML += `
                        <div class="status error">
                            <span class="status-icon">‚ùå</span>
                            ${check.name}: Offline
                        </div>
                    `;
                    log(`${check.name}: Erro de conex√£o`, 'error');
                }
            }
        }

        // Verificar configura√ß√£o
        function checkConfiguration() {
            const configDiv = document.getElementById('config-status');
            
            const configs = [
                { name: 'window.CONFIG', value: window.CONFIG ? 'Carregado' : 'N√£o encontrado', ok: !!window.CONFIG },
                { name: 'Question ID', value: state.questionId, ok: true },
                { name: 'Proxy URL', value: window.CONFIG?.proxyUrl || 'N√£o definido', ok: !!window.CONFIG?.proxyUrl },
                { name: 'Filter Mapping', value: Object.keys(window.filterMapping || {}).length + ' filtros', ok: true },
                { name: 'MetabaseAPI', value: window.MetabaseAPI ? 'Dispon√≠vel' : 'N√£o encontrado', ok: !!window.MetabaseAPI }
            ];
            
            configDiv.innerHTML = '';
            
            configs.forEach(config => {
                const status = config.ok ? 'ok' : 'error';
                const icon = config.ok ? '‚úÖ' : '‚ùå';
                
                configDiv.innerHTML += `
                    <div class="status ${status}">
                        <span class="status-icon">${icon}</span>
                        ${config.name}: ${config.value}
                    </div>
                `;
            });
        }

        // Testar conex√£o do proxy
        async function testProxyConnection() {
            log('Testando conex√£o com proxy...', 'info');
            updateTestResults('Conectando ao proxy...');
            
            try {
                const response = await fetch(`${window.CONFIG.proxyUrl}/test`);
                const data = await response.json();
                
                if (response.ok) {
                    log('Proxy conectado com sucesso!', 'success');
                    updateTestResults(`
                        <div class="success-message">
                            ‚úÖ Proxy Conectado!<br>
                            Status: ${data.status}<br>
                            Token: ${data.token_status}
                        </div>
                    `);
                } else {
                    throw new Error('Proxy retornou erro');
                }
            } catch (error) {
                log(`Erro ao conectar com proxy: ${error.message}`, 'error');
                updateTestResults(`
                    <div class="error-message">
                        ‚ùå Erro ao conectar com proxy<br>
                        ${error.message}
                    </div>
                `);
            }
        }

        // Testar informa√ß√µes da pergunta
        async function testQuestionInfo() {
            log(`Buscando informa√ß√µes da pergunta ${state.questionId}...`, 'info');
            updateTestResults('Carregando informa√ß√µes...');
            
            try {
                if (!state.api) {
                    state.api = new MetabaseAPI();
                }
                
                const info = await state.api.getQuestionInfo(state.questionId);
                
                log('Informa√ß√µes da pergunta obtidas!', 'success');
                
                const templateTags = info.dataset_query?.native?.['template-tags'] || {};
                const tagsList = Object.entries(templateTags).map(([name, tag]) => 
                    `<li>${name} (${tag.type})</li>`
                ).join('');
                
                updateTestResults(`
                    <div class="success-message">
                        ‚úÖ Pergunta Encontrada!<br>
                        Nome: ${info.name}<br>
                        Tipo: ${info.query_type}<br>
                        Template Tags: ${Object.keys(templateTags).length}
                    </div>
                    <div style="margin-top: 10px;">
                        <strong>Template Tags:</strong>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            ${tagsList}
                        </ul>
                    </div>
                `);
                
            } catch (error) {
                log(`Erro ao buscar pergunta: ${error.message}`, 'error');
                updateTestResults(`
                    <div class="error-message">
                        ‚ùå Erro ao buscar pergunta<br>
                        ${error.message}
                    </div>
                `);
            }
        }

        // Testar query simples
        async function testSimpleQuery() {
            log('Executando query simples (sem filtros)...', 'info');
            updateQueryResults('<div class="loading"></div> Executando query...');
            
            try {
                if (!state.api) {
                    state.api = new MetabaseAPI();
                }
                
                const result = await state.api.getFilteredData(state.questionId, {});
                
                log(`Query executada! ${result.metadata.rows} linhas retornadas`, 'success');
                
                displayQueryResults(result);
                
            } catch (error) {
                log(`Erro na query: ${error.message}`, 'error');
                updateQueryResults(`
                    <div class="error-message">
                        ‚ùå Erro ao executar query<br>
                        ${error.message}
                    </div>
                `);
            }
        }

        // Testar com filtros
        async function testWithFilters() {
            const filters = { data: 'past7days' };
            
            log('Executando query com filtros...', 'info');
            log(`Filtros: ${JSON.stringify(filters)}`, 'info');
            updateQueryResults('<div class="loading"></div> Executando query...');
            
            try {
                if (!state.api) {
                    state.api = new MetabaseAPI();
                }
                
                const result = await state.api.getFilteredData(state.questionId, filters);
                
                log(`Query executada! ${result.metadata.rows} linhas retornadas`, 'success');
                
                displayQueryResults(result);
                
            } catch (error) {
                log(`Erro na query: ${error.message}`, 'error');
                updateQueryResults(`
                    <div class="error-message">
                        ‚ùå Erro ao executar query<br>
                        ${error.message}
                    </div>
                `);
            }
        }

        // Construir e testar filtros
        async function buildAndTest() {
            const filters = {};
            
            document.querySelectorAll('.filter-row').forEach(row => {
                const field = row.querySelector('.filter-field').value;
                const value = row.querySelector('.filter-value').value;
                
                if (value) {
                    filters[field] = value;
                }
            });
            
            if (Object.keys(filters).length === 0) {
                alert('Adicione pelo menos um filtro!');
                return;
            }
            
            log(`Testando com filtros: ${JSON.stringify(filters)}`, 'info');
            updateFilterResults('<div class="loading"></div> Executando query...');
            
            try {
                if (!state.api) {
                    state.api = new MetabaseAPI();
                }
                
                const result = await state.api.getFilteredData(state.questionId, filters);
                
                log(`Query executada! ${result.metadata.rows} linhas retornadas`, 'success');
                
                updateFilterResults(`
                    <div class="success-message">
                        ‚úÖ Query Executada com Sucesso!<br>
                        Linhas retornadas: ${result.metadata.rows}<br>
                        Colunas: ${result.metadata.columns.length}
                    </div>
                `);
                
                // Mostrar preview dos dados
                if (result.formatted.length > 0) {
                    const preview = result.formatted.slice(0, 5);
                    const columns = result.metadata.columns.slice(0, 5);
                    
                    let tableHtml = '<table class="results-table"><thead><tr>';
                    columns.forEach(col => {
                        tableHtml += `<th>${col.display_name || col.name}</th>`;
                    });
                    tableHtml += '</tr></thead><tbody>';
                    
                    preview.forEach(row => {
                        tableHtml += '<tr>';
                        columns.forEach(col => {
                            const value = row[col.display_name || col.name];
                            tableHtml += `<td>${value || '-'}</td>`;
                        });
                        tableHtml += '</tr>';
                    });
                    
                    tableHtml += '</tbody></table>';
                    tableHtml += '<p style="text-align: center; color: #666; margin-top: 10px;">Mostrando 5 primeiras linhas</p>';
                    
                    updateFilterResults(
                        document.getElementById('filter-results').innerHTML + tableHtml
                    );
                }
                
            } catch (error) {
                log(`Erro na query: ${error.message}`, 'error');
                updateFilterResults(`
                    <div class="error-message">
                        ‚ùå Erro ao executar query<br>
                        ${error.message}
                    </div>
                `);
            }
        }

        // Adicionar linha de filtro
        function addFilterRow() {
            const container = document.getElementById('filter-rows');
            const newRow = document.createElement('div');
            newRow.className = 'filter-row';
            newRow.innerHTML = `
                <select class="filter-field">
                    <option value="data">Data</option>
                    <option value="conta">Conta</option>
                    <option value="campanha">Campanha</option>
                    <option value="plataforma">Plataforma</option>
                    <option value="device">Dispositivo</option>
                </select>
                <input type="text" class="filter-value" placeholder="Valor">
                <button onclick="removeFilterRow(this)">‚úñ</button>
            `;
            container.appendChild(newRow);
        }

        // Remover linha de filtro
        function removeFilterRow(button) {
            button.parentElement.remove();
        }

        // Atualizar resultados
        function updateTestResults(html) {
            document.getElementById('test-results').innerHTML = html;
        }

        function updateQueryResults(html) {
            document.getElementById('query-results').innerHTML = html;
        }

        function updateFilterResults(html) {
            document.getElementById('filter-results').innerHTML = html;
        }

        // Exibir resultados da query
        function displayQueryResults(result) {
            const columns = result.metadata.columns.slice(0, 8); // Primeiras 8 colunas
            const rows = result.formatted.slice(0, 10); // Primeiras 10 linhas
            
            let html = `
                <div class="success-message">
                    ‚úÖ ${result.metadata.rows} linhas √ó ${result.metadata.columns.length} colunas
                </div>
            `;
            
            if (rows.length > 0) {
                html += '<table class="results-table"><thead><tr>';
                
                columns.forEach(col => {
                    html += `<th>${col.display_name || col.name}</th>`;
                });
                
                html += '</tr></thead><tbody>';
                
                rows.forEach(row => {
                    html += '<tr>';
                    columns.forEach(col => {
                        const value = row[col.display_name || col.name];
                        html += `<td>${formatValue(value)}</td>`;
                    });
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                html += '<p style="text-align: center; color: #666; margin-top: 10px;">Mostrando 10 primeiras linhas de ' + result.metadata.rows + '</p>';
            }
            
            updateQueryResults(html);
        }

        // Formatar valor para exibi√ß√£o
        function formatValue(value) {
            if (value === null || value === undefined) return '-';
            if (typeof value === 'number') {
                return value.toLocaleString('pt-BR');
            }
            return value;
        }

        // Inicializar
        window.addEventListener('DOMContentLoaded', () => {
            log('Testador Visual inicializado', 'success');
            checkAllConnections();
            checkConfiguration();
        });
    </script>
</body>
</html>