<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Campanhas</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: white;
        }
        
        .dashboard-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .controls {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            background: #fafafa;
            flex-shrink: 0;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        label {
            font-weight: 500;
            color: #333;
            font-size: 13px;
            white-space: nowrap;
        }
        
        select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            background: white;
            min-width: 140px;
        }
        
        button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        button:hover {
            background: #357ae8;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .data-info {
            margin-left: auto;
            font-size: 13px;
            color: #666;
            padding: 6px 12px;
            background: #e8f0fe;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .data-info.loading {
            background: #fff3cd;
            color: #856404;
        }
        
        .data-info.error {
            background: #ffebee;
            color: #c62828;
        }
        
        .filter-info {
            font-size: 11px;
            color: #666;
            padding: 4px 8px;
            background: #f0f0f0;
            border-radius: 3px;
        }
        
        .chart-container {
            flex: 1;
            padding: 0;
            position: relative;
            overflow: hidden;
        }
        
        #main-chart {
            width: 100%;
            height: 100%;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.9);
            z-index: 10;
        }
        
        .loading-content {
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4285f4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .debug-panel {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-size: 11px;
            font-family: monospace;
            max-width: 400px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        
        .debug-panel.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="controls">
            <div class="control-group">
                <label>M√©tricas em Barras:</label>
                <select id="barMetrics" multiple size="4">
                    <option value="impressions" selected>Impress√µes</option>
                    <option value="clicks" selected>Cliques</option>
                    <option value="spend" selected>Gasto</option>
                    <option value="conversions" selected>Convers√µes</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>M√©tricas em Linhas:</label>
                <select id="lineMetrics" multiple size="4">
                    <option value="cpm" selected>CPM</option>
                    <option value="ctr" selected>CTR %</option>
                    <option value="cpc" selected>CPC</option>
                    <option value="convRate" selected>Taxa Conv %</option>
                </select>
            </div>
            
            <button onclick="updateChart()" id="updateBtn">Atualizar Gr√°fico</button>
            <button onclick="loadData()" id="refreshBtn">üîÑ Recarregar</button>
            
            <div class="data-info loading" id="dataInfo">Inicializando...</div>
            <div class="filter-info" id="filterInfo"></div>
        </div>
        
        <div class="chart-container">
            <div id="loadingOverlay" class="loading-overlay">
                <div class="loading-content">
                    <div class="spinner"></div>
                    <div id="loadingText">Carregando dados...</div>
                </div>
            </div>
            <div id="main-chart"></div>
        </div>
        
        <div class="debug-panel" id="debugPanel"></div>
    </div>

    <!-- Scripts -->
    <script src="http://localhost:8090/api/metabase-api.js"></script>
    <script src="http://localhost:8090/graficos/dashboard-campanhas/config.js"></script>
    <script>
        // Vari√°veis globais
        let myChart = null;
        let metabaseAPI = null;
        let rawData = [];
        let processedData = {};
        let totalRows = 0;
        let currentFilters = {};
        
        // Debug mode
        const DEBUG = window.location.search.includes('debug=true');
        
        function log(message, data = null) {
            if (DEBUG) {
                console.log(`[Dashboard] ${message}`, data || '');
                const panel = document.getElementById('debugPanel');
                panel.classList.add('show');
                const time = new Date().toLocaleTimeString();
                panel.innerHTML = `<div>${time}: ${message}</div>${panel.innerHTML}`;
                if (panel.children.length > 20) {
                    panel.removeChild(panel.lastChild);
                }
            }
        }
        
        // Mapeamento dos par√¢metros do dashboard para os par√¢metros da query
        const PARAM_MAPPING = {
            // Mapeamento de nomes do dashboard -> nomes da query
            'data': 'data',
            'data_inicio': 'data',
            'data_fim': 'data',
            'start_date': 'data',
            'end_date': 'data',
            'date_range': 'data',
            'conta': 'conta',
            'account': 'conta',
            'account_name': 'conta',
            'campanha': 'campanha',
            'campaign': 'campanha',
            'campaign_name': 'campanha',
            'adset': 'adset',
            'adset_name': 'adset',
            'ad': 'ad_name',
            'ad_name': 'ad_name',
            'plataforma': 'plataforma',
            'platform': 'plataforma',
            'posicao': 'posicao',
            'position': 'posicao',
            'device': 'device',
            'objective': 'objective',
            'optimization_goal': 'optimization_goal',
            'buying_type': 'buying_type',
            'action_type': 'action_type_filter'
        };
        
        // Fun√ß√£o para extrair par√¢metros da URL
        function getUrlParameters() {
            const params = new URLSearchParams(window.location.search);
            const filters = {};
            
            // Iterar sobre todos os par√¢metros poss√≠veis
            for (const [key, value] of params.entries()) {
                if (value && value !== '{{' + key + '}}' && key !== 'debug') {
                    filters[key] = value;
                }
            }
            
            log('Par√¢metros da URL extra√≠dos', filters);
            return filters;
        }
        
        // Converter filtros do dashboard para par√¢metros da API
        function convertFiltersToApiParams(filters) {
            const apiParams = [];
            
            // Tratar data especialmente
            let dateFilter = null;
            
            // Verificar diferentes formatos de data
            if (filters.data) {
                dateFilter = filters.data;
            } else if (filters.start_date && filters.end_date) {
                dateFilter = `${filters.start_date}~${filters.end_date}`;
            } else if (filters.data_inicio && filters.data_fim) {
                dateFilter = `${filters.data_inicio}~${filters.data_fim}`;
            }
            
            if (dateFilter) {
                apiParams.push({
                    type: 'date/all-options',
                    target: ['variable', ['template-tag', 'data']],
                    value: dateFilter
                });
                log(`Filtro de data configurado: ${dateFilter}`);
            }
            
            // Mapear outros filtros
            Object.entries(filters).forEach(([key, value]) => {
                // Pular filtros de data j√° processados
                if (['data', 'start_date', 'end_date', 'data_inicio', 'data_fim', 'debug'].includes(key)) {
                    return;
                }
                
                // Encontrar o nome correto do par√¢metro
                const mappedParam = PARAM_MAPPING[key] || key;
                
                // Criar par√¢metro para API
                apiParams.push({
                    type: 'category',
                    target: ['variable', ['template-tag', mappedParam]],
                    value: value
                });
                
                log(`Filtro mapeado: ${key} -> ${mappedParam} = ${value}`);
            });
            
            return apiParams;
        }
        
        // Inicializar ao carregar
        window.addEventListener('DOMContentLoaded', () => {
            log('Dashboard inicializado');
            
            // Inicializar o gr√°fico ECharts
            myChart = echarts.init(document.getElementById('main-chart'));
            
            // Responsividade
            window.addEventListener('resize', () => {
                if (myChart) {
                    myChart.resize();
                }
            });
            
            // Capturar filtros da URL
            currentFilters = getUrlParameters();
            
            // Carregar dados automaticamente
            if (METABASE_CONFIG.chart.autoLoad) {
                loadData();
            }
        });
        
        // Fun√ß√£o para atualizar info de dados
        function updateDataInfo(status, count = null) {
            const dataInfo = document.getElementById('dataInfo');
            const filterInfo = document.getElementById('filterInfo');
            
            switch(status) {
                case 'loading':
                    dataInfo.className = 'data-info loading';
                    dataInfo.textContent = 'Carregando...';
                    break;
                case 'success':
                    dataInfo.className = 'data-info';
                    dataInfo.textContent = `‚úì ${count.toLocaleString('pt-BR')} linhas`;
                    
                    // Mostrar filtros ativos
                    const filterCount = Object.keys(currentFilters).length;
                    if (filterCount > 0) {
                        const filterNames = Object.keys(currentFilters).filter(k => k !== 'debug').join(', ');
                        filterInfo.textContent = `Filtros: ${filterNames}`;
                        filterInfo.style.display = 'inline-block';
                    } else {
                        filterInfo.textContent = 'Sem filtros';
                        filterInfo.style.display = 'inline-block';
                    }
                    break;
                case 'error':
                    dataInfo.className = 'data-info error';
                    dataInfo.textContent = '‚úó Erro';
                    filterInfo.style.display = 'none';
                    break;
            }
        }
        
        // Fun√ß√£o para mostrar/esconder loading
        function showLoading(show, text = 'Carregando dados...') {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
            if (show) {
                document.getElementById('loadingText').textContent = text;
            }
        }
        
        // Fun√ß√£o para carregar dados
        async function loadData() {
            showLoading(true, 'Conectando ao Metabase...');
            updateDataInfo('loading');
            
            try {
                const baseUrl = getMetabaseUrl();
                
                if (METABASE_CONFIG.authMethod === 'credentials') {
                    metabaseAPI = new MetabaseAPI(
                        baseUrl,
                        METABASE_CONFIG.credentials.username,
                        METABASE_CONFIG.credentials.password
                    );
                    
                    showLoading(true, 'Autenticando...');
                    await metabaseAPI.authenticate();
                    
                    // Converter filtros para formato da API
                    const apiParameters = convertFiltersToApiParams(currentFilters);
                    log('Par√¢metros para API', apiParameters);
                    
                    // Buscar dados com filtros aplicados na API
                    showLoading(true, 'Baixando dados filtrados...');
                    const data = await metabaseAPI.getQuestionData(METABASE_CONFIG.questionId, apiParameters);
                    
                    if (data && data.formatted && data.formatted.length > 0) {
                        rawData = data.formatted;
                        totalRows = data.formatted.length;
                        
                        log(`Dados recebidos: ${totalRows} linhas`);
                        
                        showLoading(true, 'Processando dados...');
                        processedData = processData(rawData);
                        
                        showLoading(true, 'Renderizando gr√°fico...');
                        createChart();
                        
                        showLoading(false);
                        updateDataInfo('success', totalRows);
                        
                    } else {
                        throw new Error('Nenhum dado retornado com os filtros aplicados');
                    }
                    
                } else {
                    throw new Error('M√©todo de autentica√ß√£o n√£o suportado');
                }
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                log('Erro', error.message);
                updateDataInfo('error');
                showLoading(false);
                
                // Mostrar erro no gr√°fico
                myChart.setOption({
                    title: {
                        text: 'Erro ao carregar dados',
                        subtext: error.message,
                        left: 'center',
                        top: 'middle'
                    }
                });
            }
        }
        
        // Escutar mudan√ßas de filtros do Metabase
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'dashboard-filters') {
                log('Filtros recebidos via postMessage', event.data.filters);
                
                // Atualizar filtros
                currentFilters = { ...currentFilters, ...event.data.filters };
                
                // Recarregar dados
                loadData();
            }
        });
        
        // Processar dados (mant√©m igual)
        function processData(data) {
            const groupedData = {};
            const campaigns = new Set();
            const dates = new Set();
            
            data.forEach(row => {
                const date = row.date;
                const campaign = row.campaign_name || 'Sem Campanha';
                
                dates.add(date);
                campaigns.add(campaign);
                
                if (!groupedData[date]) {
                    groupedData[date] = {};
                }
                
                if (!groupedData[date][campaign]) {
                    groupedData[date][campaign] = {
                        impressions: 0,
                        clicks: 0,
                        spend: 0,
                        conversions: 0,
                        revenue: 0
                    };
                }
                
                groupedData[date][campaign].impressions += row.impressions || 0;
                groupedData[date][campaign].clicks += row.clicks || 0;
                groupedData[date][campaign].spend += row.spend || 0;
                groupedData[date][campaign].conversions += row.conversions || 0;
                groupedData[date][campaign].revenue += row.revenue || 0;
            });
            
            const sortedDates = Array.from(dates).sort();
            const campaignsList = Array.from(campaigns).sort();
            
            const seriesData = {
                dates: sortedDates,
                campaigns: campaignsList,
                impressions: {},
                clicks: {},
                spend: {},
                conversions: {},
                cpm: [],
                ctr: [],
                cpc: [],
                convRate: []
            };
            
            campaignsList.forEach(campaign => {
                seriesData.impressions[campaign] = [];
                seriesData.clicks[campaign] = [];
                seriesData.spend[campaign] = [];
                seriesData.conversions[campaign] = [];
            });
            
            sortedDates.forEach(date => {
                let totalImpressions = 0;
                let totalClicks = 0;
                let totalSpend = 0;
                let totalConversions = 0;
                
                campaignsList.forEach(campaign => {
                    const data = groupedData[date] && groupedData[date][campaign] || {};
                    
                    seriesData.impressions[campaign].push(data.impressions || 0);
                    seriesData.clicks[campaign].push(data.clicks || 0);
                    seriesData.spend[campaign].push(data.spend || 0);
                    seriesData.conversions[campaign].push(data.conversions || 0);
                    
                    totalImpressions += data.impressions || 0;
                    totalClicks += data.clicks || 0;
                    totalSpend += data.spend || 0;
                    totalConversions += data.conversions || 0;
                });
                
                // Usar valores j√° calculados pela query quando dispon√≠veis
                if (sortedDates.length === 1 && rawData.length === 1) {
                    // Se temos apenas um registro, usar os valores calculados
                    seriesData.cpm.push(rawData[0].CPM || null);
                    seriesData.ctr.push(rawData[0]['CTR %'] || null);
                    seriesData.cpc.push(rawData[0].CPC || null);
                    seriesData.convRate.push(rawData[0]['ConvRate %'] || null);
                } else {
                    // Calcular m√©tricas agregadas
                    seriesData.cpm.push(totalImpressions > 0 ? (totalSpend / (totalImpressions / 1000)) : null);
                    seriesData.ctr.push(totalImpressions > 0 ? (totalClicks / totalImpressions * 100) : null);
                    seriesData.cpc.push(totalClicks > 0 ? (totalSpend / totalClicks) : null);
                    seriesData.convRate.push(totalClicks > 0 ? (totalConversions / totalClicks * 100) : null);
                }
            });
            
            return seriesData;
        }
        
        // Criar gr√°fico (mant√©m igual ao anterior)
        function createChart() {
            const colors = [
                '#5470c6', '#91cc75', '#fac858', '#ee6666', '#73c0de',
                '#3ba272', '#fc8452', '#9a60b4', '#ea7ccc', '#ff9a00'
            ];
            
            const barSeries = [];
            const selectedBarMetrics = Array.from(document.getElementById('barMetrics').selectedOptions)
                .map(option => option.value);
            
            let yAxisIndex = 0;
            selectedBarMetrics.forEach((metric) => {
                processedData.campaigns.forEach((campaign, campaignIndex) => {
                    barSeries.push({
                        name: `${campaign} - ${getMetricLabel(metric)}`,
                        type: 'bar',
                        stack: metric,
                        emphasis: { focus: 'series' },
                        yAxisIndex: yAxisIndex,
                        data: processedData[metric][campaign],
                        itemStyle: { color: colors[campaignIndex % colors.length] }
                    });
                });
                yAxisIndex++;
            });
            
            const lineSeries = [];
            const selectedLineMetrics = Array.from(document.getElementById('lineMetrics').selectedOptions)
                .map(option => option.value);
            
            const lineMetricConfig = {
                cpm: { name: 'CPM', color: '#ff7875' },
                ctr: { name: 'CTR %', color: '#95de64' },
                cpc: { name: 'CPC', color: '#ffd666' },
                convRate: { name: 'Taxa Conv %', color: '#5cdbd3' }
            };
            
            selectedLineMetrics.forEach(metric => {
                const config = lineMetricConfig[metric];
                if (config) {
                    lineSeries.push({
                        name: config.name,
                        type: 'line',
                        yAxisIndex: yAxisIndex,
                        data: processedData[metric],
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 6,
                        lineStyle: { width: 3, color: config.color },
                        itemStyle: { color: config.color },
                        emphasis: { scale: 1.5 }
                    });
                    yAxisIndex++;
                }
            });
            
            // Configurar eixos Y dinamicamente
            const yAxisConfig = [];
            const yAxisNames = [
                ...selectedBarMetrics.map(m => getMetricLabel(m)),
                ...selectedLineMetrics.map(m => lineMetricConfig[m]?.name || m)
            ];
            
            yAxisNames.forEach((name, index) => {
                const isRight = index >= selectedBarMetrics.length;
                yAxisConfig.push({
                    type: 'value',
                    name: name,
                    position: isRight ? 'right' : 'left',
                    offset: isRight ? 
                        (index - selectedBarMetrics.length) * 60 : 
                        index * 60,
                    axisLine: { show: true },
                    axisLabel: { 
                        formatter: (value) => {
                            if (name.includes('%')) return value.toFixed(1) + '%';
                            if (name.includes('$') || name.includes('Gasto') || name.includes('CPM') || name.includes('CPC')) 
                                return '$' + value.toFixed(2);
                            return value.toLocaleString('pt-BR');
                        }
                    }
                });
            });
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' }
                },
                toolbox: {
                    right: 20,
                    feature: {
                        dataZoom: { show: true },
                        restore: { show: true },
                        saveAsImage: { show: true }
                    }
                },
                legend: {
                    type: 'scroll',
                    orient: 'horizontal',
                    bottom: 10,
                    height: 40
                },
                grid: {
                    left: selectedBarMetrics.length * 70 + 20,
                    right: selectedLineMetrics.length * 70 + 20,
                    bottom: 100,
                    top: 60,
                    containLabel: false
                },
                dataZoom: [{
                    type: 'slider',
                    show: true,
                    xAxisIndex: [0],
                    start: 0,
                    end: 100,
                    bottom: 55,
                    height: 20
                }, {
                    type: 'inside',
                    xAxisIndex: [0],
                    start: 0,
                    end: 100
                }],
                xAxis: {
                    type: 'category',
                    boundaryGap: true,
                    data: processedData.dates,
                    axisLabel: {
                        rotate: 45,
                        formatter: value => {
                            const date = new Date(value);
                            return `${date.getDate()}/${date.getMonth() + 1}`;
                        }
                    }
                },
                yAxis: yAxisConfig,
                series: [...barSeries, ...lineSeries]
            };
            
            myChart.setOption(option, true);
        }
        
        // Atualizar gr√°fico
        function updateChart() {
            if (processedData.dates) {
                createChart();
            }
        }
        
        function getMetricLabel(metric) {
            const labels = {
                impressions: 'Impress√µes',
                clicks: 'Cliques',
                spend: 'Gasto ($)',
                conversions: 'Convers√µes'
            };
            return labels[metric] || metric;
        }
    </script>
</body>
</html>
