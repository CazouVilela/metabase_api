<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Captura de Valores M√∫ltiplos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1976d2;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
        }
        .error {
            background: #ffebee;
            border-left: 4px solid #f44336;
        }
        .info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .code-block {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Teste de Captura de Valores M√∫ltiplos</h1>
        
        <h2>1. Analisar Campo Device</h2>
        <button onclick="analyzeDeviceField()">Analisar Estrutura do Device</button>
        <div id="deviceAnalysis"></div>
        
        <h2>2. Buscar Valores Reais</h2>
        <button onclick="findRealValues()">Tentar Extrair Valores</button>
        <div id="valuesResult"></div>
        
        <h2>3. Script Manual para Console</h2>
        <div class="code-block" id="manualScript">
// Script para executar no console
(function() {
    // Encontrar o fieldset do Device (geralmente o 6¬∫)
    const fieldsets = window.parent.document.querySelectorAll('fieldset');
    const deviceFieldset = fieldsets[5]; // Index 5 = 6¬∫ fieldset
    
    if (!deviceFieldset) {
        console.error('Fieldset do Device n√£o encontrado');
        return;
    }
    
    console.log('=== An√°lise do campo Device ===');
    
    // 1. Buscar todos os elementos dentro do fieldset
    console.log('\n1. Estrutura HTML:');
    console.log(deviceFieldset.outerHTML);
    
    // 2. Buscar elementos que possam conter os valores
    const possibleValueElements = deviceFieldset.querySelectorAll('*');
    console.log(`\n2. Total de elementos dentro: ${possibleValueElements.length}`);
    
    // 3. Buscar atributos relevantes
    console.log('\n3. Elementos com atributos interessantes:');
    possibleValueElements.forEach(el => {
        const attrs = ['title', 'data-value', 'data-values', 'aria-label', 'value'];
        attrs.forEach(attr => {
            const value = el.getAttribute(attr);
            if (value && value.length > 0) {
                console.log(`   ${el.tagName}.${el.className} - ${attr}="${value}"`);
            }
        });
    });
    
    // 4. Buscar no React
    console.log('\n4. Tentando acessar dados do React:');
    const reactKey = Object.keys(deviceFieldset).find(key => 
        key.startsWith('__reactInternalInstance') || 
        key.startsWith('__reactFiber') ||
        key.startsWith('__react')
    );
    
    if (reactKey) {
        let fiber = deviceFieldset[reactKey];
        let depth = 0;
        
        while (fiber && depth < 20) {
            if (fiber.memoizedProps) {
                const props = fiber.memoizedProps;
                if (props.value || props.values || props.selectedValues) {
                    console.log(`   Encontrado em memoizedProps:`, {
                        value: props.value,
                        values: props.values,
                        selectedValues: props.selectedValues
                    });
                }
            }
            fiber = fiber.return || fiber.child;
            depth++;
        }
    }
    
    // 5. Buscar texto em elementos espec√≠ficos
    console.log('\n5. Textos encontrados:');
    const textElements = deviceFieldset.querySelectorAll('span, div, li');
    const texts = new Set();
    textElements.forEach(el => {
        const text = el.textContent?.trim();
        if (text && text !== '2 sele√ß√µes' && !text.includes('sele√ß√µes')) {
            texts.add(text);
        }
    });
    console.log('   Textos √∫nicos:', Array.from(texts));
})();
        </div>
        
        <h2>4. Solu√ß√£o Tempor√°ria</h2>
        <div class="info result">
            <p><strong>üí° Enquanto desenvolvemos a solu√ß√£o definitiva, voc√™ pode:</strong></p>
            <ol>
                <li>Clicar no campo Device para abrir o dropdown</li>
                <li>Com o dropdown aberto, executar o script de captura</li>
                <li>O script conseguir√° ler os valores do dropdown aberto</li>
            </ol>
        </div>
    </div>

    <script>
        function analyzeDeviceField() {
            const results = document.getElementById('deviceAnalysis');
            
            if (window.parent === window) {
                results.innerHTML = '<div class="result error">‚ùå Execute dentro do iframe no Metabase</div>';
                return;
            }
            
            try {
                const fieldsets = window.parent.document.querySelectorAll('fieldset');
                const deviceFieldset = fieldsets[5]; // Device √© o 6¬∫ fieldset
                
                if (!deviceFieldset) {
                    results.innerHTML = '<div class="result error">‚ùå Fieldset do Device n√£o encontrado</div>';
                    return;
                }
                
                let html = '<div class="result info">üìä An√°lise do Campo Device:</div>';
                
                // Estrutura b√°sica
                const legend = deviceFieldset.querySelector('legend');
                const valueElement = deviceFieldset.querySelector('.lnsju');
                
                html += '<pre>';
                html += `Legend: ${legend ? legend.textContent : 'N/A'}\n`;
                html += `Valor vis√≠vel: ${valueElement ? valueElement.textContent : 'N/A'}\n`;
                html += `\nClasses do container: ${deviceFieldset.className}\n`;
                html += `Classes do valor: ${valueElement?.className}\n`;
                html += '</pre>';
                
                // Buscar poss√≠veis elementos com valores
                html += '<h4>Elementos encontrados:</h4><ul>';
                const elements = deviceFieldset.querySelectorAll('*');
                elements.forEach(el => {
                    if (el.textContent && !el.children.length) {
                        html += `<li>${el.tagName} - "${el.textContent.trim()}"</li>`;
                    }
                });
                html += '</ul>';
                
                results.innerHTML = html;
                
            } catch (error) {
                results.innerHTML = `<div class="result error">‚ùå Erro: ${error.message}</div>`;
            }
        }
        
        function findRealValues() {
            const results = document.getElementById('valuesResult');
            
            if (window.parent === window) {
                results.innerHTML = '<div class="result error">‚ùå Execute dentro do iframe no Metabase</div>';
                return;
            }
            
            try {
                // Executar v√°rias estrat√©gias
                const strategies = [
                    checkDropdownOpen,
                    checkReactProps,
                    checkDataAttributes,
                    checkHiddenElements
                ];
                
                let html = '<h3>Tentativas de Extra√ß√£o:</h3>';
                
                strategies.forEach((strategy, index) => {
                    const result = strategy();
                    html += `<div class="result ${result.success ? 'success' : 'error'}">`;
                    html += `<strong>Estrat√©gia ${index + 1}: ${result.name}</strong><br>`;
                    html += `${result.success ? '‚úÖ' : '‚ùå'} ${result.message}`;
                    if (result.values) {
                        html += `<br>Valores: ${JSON.stringify(result.values)}`;
                    }
                    html += '</div>';
                });
                
                results.innerHTML = html;
                
            } catch (error) {
                results.innerHTML = `<div class="result error">‚ùå Erro: ${error.message}</div>`;
            }
        }
        
        function checkDropdownOpen() {
            const dropdown = window.parent.document.querySelector('[role="listbox"], .ant-select-dropdown');
            if (dropdown) {
                const selected = dropdown.querySelectorAll('[aria-selected="true"]');
                if (selected.length > 0) {
                    const values = Array.from(selected).map(el => el.textContent.trim());
                    return {
                        success: true,
                        name: 'Dropdown Aberto',
                        message: 'Valores encontrados no dropdown',
                        values: values
                    };
                }
            }
            return {
                success: false,
                name: 'Dropdown Aberto',
                message: 'Dropdown n√£o est√° aberto ou sem valores selecionados'
            };
        }
        
        function checkReactProps() {
            try {
                const fieldsets = window.parent.document.querySelectorAll('fieldset');
                const deviceFieldset = fieldsets[5];
                
                const reactKeys = Object.keys(deviceFieldset).filter(key => 
                    key.startsWith('__react')
                );
                
                if (reactKeys.length > 0) {
                    // Implementa√ß√£o simplificada
                    return {
                        success: false,
                        name: 'React Props',
                        message: `Encontradas ${reactKeys.length} chaves React, mas extra√ß√£o complexa`
                    };
                }
            } catch (e) {}
            
            return {
                success: false,
                name: 'React Props',
                message: 'N√£o foi poss√≠vel acessar propriedades React'
            };
        }
        
        function checkDataAttributes() {
            const fieldsets = window.parent.document.querySelectorAll('fieldset');
            const deviceFieldset = fieldsets[5];
            
            const elements = deviceFieldset.querySelectorAll('*');
            let foundValues = [];
            
            elements.forEach(el => {
                ['data-value', 'data-values', 'data-selected'].forEach(attr => {
                    const value = el.getAttribute(attr);
                    if (value) {
                        foundValues.push({element: el.tagName, attr: attr, value: value});
                    }
                });
            });
            
            if (foundValues.length > 0) {
                return {
                    success: true,
                    name: 'Data Attributes',
                    message: 'Atributos data- encontrados',
                    values: foundValues
                };
            }
            
            return {
                success: false,
                name: 'Data Attributes',
                message: 'Nenhum atributo data- relevante encontrado'
            };
        }
        
        function checkHiddenElements() {
            const fieldsets = window.parent.document.querySelectorAll('fieldset');
            const deviceFieldset = fieldsets[5];
            
            const hiddenInputs = deviceFieldset.querySelectorAll('input[type="hidden"]');
            if (hiddenInputs.length > 0) {
                const values = Array.from(hiddenInputs).map(input => input.value);
                return {
                    success: true,
                    name: 'Inputs Hidden',
                    message: 'Inputs ocultos encontrados',
                    values: values
                };
            }
            
            return {
                success: false,
                name: 'Inputs Hidden',
                message: 'Nenhum input oculto encontrado'
            };
        }
    </script>
</body>
</html>