<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Campanhas</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: white;
        }
        
        .dashboard-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .controls {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            background: #fafafa;
            flex-shrink: 0;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        label {
            font-weight: 500;
            color: #333;
            font-size: 13px;
            white-space: nowrap;
        }
        
        select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            background: white;
            min-width: 140px;
        }
        
        button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        button:hover {
            background: #357ae8;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .data-info {
            margin-left: auto;
            font-size: 13px;
            color: #666;
            padding: 6px 12px;
            background: #e8f0fe;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .data-info.loading {
            background: #fff3cd;
            color: #856404;
        }
        
        .data-info.error {
            background: #ffebee;
            color: #c62828;
        }
        
        .chart-container {
            flex: 1;
            padding: 0;
            position: relative;
            overflow: hidden;
        }
        
        #main-chart {
            width: 100%;
            height: 100%;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.9);
            z-index: 10;
        }
        
        .loading-content {
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4285f4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            color: #d32f2f;
            padding: 20px;
            text-align: center;
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .controls {
                padding: 10px;
                gap: 10px;
            }
            
            .control-group {
                flex: 1 1 100%;
            }
            
            select {
                width: 100%;
            }
            
            .data-info {
                flex: 1 1 100%;
                text-align: center;
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="controls">
            <div class="control-group">
                <label>M√©tricas em Barras:</label>
                <select id="barMetrics" multiple size="4">
                    <option value="impressions" selected>Impress√µes</option>
                    <option value="clicks" selected>Cliques</option>
                    <option value="spend" selected>Gasto</option>
                    <option value="conversions" selected>Convers√µes</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>M√©tricas em Linhas:</label>
                <select id="lineMetrics" multiple size="4">
                    <option value="cpm" selected>CPM</option>
                    <option value="ctr" selected>CTR %</option>
                    <option value="cpc" selected>CPC</option>
                    <option value="convRate" selected>Taxa Conv %</option>
                </select>
            </div>
            
            <button onclick="updateChart()" id="updateBtn">Atualizar Gr√°fico</button>
            <button onclick="loadData()" id="refreshBtn">üîÑ Recarregar Dados</button>
            
            <div class="data-info loading" id="dataInfo">Carregando...</div>
        </div>
        
        <div class="chart-container">
            <div id="loadingOverlay" class="loading-overlay">
                <div class="loading-content">
                    <div class="spinner"></div>
                    <div>Carregando dados...</div>
                </div>
            </div>
            <div id="main-chart"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="http://localhost:8090/api/metabase-api.js"></script>
    <script src="http://localhost:8090/graficos/dashboard-campanhas/config.js"></script>
    <script>
        // Vari√°veis globais
        let myChart = null;
        let metabaseAPI = null;
        let rawData = [];
        let processedData = {};
        let totalRows = 0;
        
        // Inicializar ao carregar
        window.addEventListener('DOMContentLoaded', () => {
            // Inicializar o gr√°fico ECharts
            myChart = echarts.init(document.getElementById('main-chart'));
            
            // Responsividade
            window.addEventListener('resize', () => {
                if (myChart) {
                    myChart.resize();
                }
            });
            
            // Carregar dados automaticamente se configurado
            if (METABASE_CONFIG.chart.autoLoad) {
                loadData();
            }
        });
        
        // Fun√ß√£o para atualizar info de dados
        function updateDataInfo(status, count = null) {
            const dataInfo = document.getElementById('dataInfo');
            
            switch(status) {
                case 'loading':
                    dataInfo.className = 'data-info loading';
                    dataInfo.textContent = 'Carregando dados...';
                    break;
                case 'success':
                    dataInfo.className = 'data-info';
                    dataInfo.textContent = `‚úì ${count.toLocaleString('pt-BR')} linhas carregadas`;
                    break;
                case 'error':
                    dataInfo.className = 'data-info error';
                    dataInfo.textContent = '‚úó Erro ao carregar dados';
                    break;
            }
        }
        
        // Fun√ß√£o para mostrar/esconder loading
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }
        
        // Fun√ß√£o para carregar dados
        async function loadData() {
            showLoading(true);
            updateDataInfo('loading');
            
            try {
                const baseUrl = getMetabaseUrl();
                
                if (METABASE_CONFIG.authMethod === 'credentials') {
                    metabaseAPI = new MetabaseAPI(
                        baseUrl,
                        METABASE_CONFIG.credentials.username,
                        METABASE_CONFIG.credentials.password
                    );
                    
                    const data = await metabaseAPI.getQuestionDataComplete(METABASE_CONFIG.questionId);
                    
                    if (data && data.formatted && data.formatted.length > 0) {
                        rawData = data.formatted;
                        totalRows = data.formatted.length;
                        processedData = processData(rawData);
                        
                        createChart();
                        showLoading(false);
                        updateDataInfo('success', totalRows);
                        
                    } else {
                        throw new Error('Nenhum dado encontrado');
                    }
                }
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                updateDataInfo('error');
                showLoading(false);
                
                // Mostrar erro no gr√°fico
                myChart.setOption({
                    title: {
                        text: 'Erro ao carregar dados',
                        subtext: error.message,
                        left: 'center',
                        top: 'middle'
                    }
                });
            }
        }
        
        // Processar dados
        function processData(data) {
            const groupedData = {};
            const campaigns = new Set();
            const dates = new Set();
            
            data.forEach(row => {
                const date = row.date;
                const campaign = row.campaign_name || 'Sem Campanha';
                
                dates.add(date);
                campaigns.add(campaign);
                
                if (!groupedData[date]) {
                    groupedData[date] = {};
                }
                
                if (!groupedData[date][campaign]) {
                    groupedData[date][campaign] = {
                        impressions: 0,
                        clicks: 0,
                        spend: 0,
                        conversions: 0,
                        revenue: 0
                    };
                }
                
                groupedData[date][campaign].impressions += row.impressions || 0;
                groupedData[date][campaign].clicks += row.clicks || 0;
                groupedData[date][campaign].spend += row.spend || 0;
                groupedData[date][campaign].conversions += row.conversions || 0;
                groupedData[date][campaign].revenue += row.revenue || 0;
            });
            
            const sortedDates = Array.from(dates).sort();
            const campaignsList = Array.from(campaigns).sort();
            
            const seriesData = {
                dates: sortedDates,
                campaigns: campaignsList,
                impressions: {},
                clicks: {},
                spend: {},
                conversions: {},
                cpm: [],
                ctr: [],
                cpc: [],
                convRate: []
            };
            
            campaignsList.forEach(campaign => {
                seriesData.impressions[campaign] = [];
                seriesData.clicks[campaign] = [];
                seriesData.spend[campaign] = [];
                seriesData.conversions[campaign] = [];
            });
            
            sortedDates.forEach(date => {
                let totalImpressions = 0;
                let totalClicks = 0;
                let totalSpend = 0;
                let totalConversions = 0;
                
                campaignsList.forEach(campaign => {
                    const data = groupedData[date] && groupedData[date][campaign] || {};
                    
                    seriesData.impressions[campaign].push(data.impressions || 0);
                    seriesData.clicks[campaign].push(data.clicks || 0);
                    seriesData.spend[campaign].push(data.spend || 0);
                    seriesData.conversions[campaign].push(data.conversions || 0);
                    
                    totalImpressions += data.impressions || 0;
                    totalClicks += data.clicks || 0;
                    totalSpend += data.spend || 0;
                    totalConversions += data.conversions || 0;
                });
                
                seriesData.cpm.push(totalImpressions > 0 ? (totalSpend / (totalImpressions / 1000)) : null);
                seriesData.ctr.push(totalImpressions > 0 ? (totalClicks / totalImpressions * 100) : null);
                seriesData.cpc.push(totalClicks > 0 ? (totalSpend / totalClicks) : null);
                seriesData.convRate.push(totalClicks > 0 ? (totalConversions / totalClicks * 100) : null);
            });
            
            return seriesData;
        }
        
        // Criar gr√°fico
        function createChart() {
            const colors = [
                '#5470c6', '#91cc75', '#fac858', '#ee6666', '#73c0de',
                '#3ba272', '#fc8452', '#9a60b4', '#ea7ccc', '#ff9a00'
            ];
            
            const barSeries = [];
            const selectedBarMetrics = Array.from(document.getElementById('barMetrics').selectedOptions)
                .map(option => option.value);
            
            let yAxisIndex = 0;
            selectedBarMetrics.forEach((metric) => {
                processedData.campaigns.forEach((campaign, campaignIndex) => {
                    barSeries.push({
                        name: `${campaign} - ${getMetricLabel(metric)}`,
                        type: 'bar',
                        stack: metric,
                        emphasis: { focus: 'series' },
                        yAxisIndex: yAxisIndex,
                        data: processedData[metric][campaign],
                        itemStyle: { color: colors[campaignIndex % colors.length] }
                    });
                });
                yAxisIndex++;
            });
            
            const lineSeries = [];
            const selectedLineMetrics = Array.from(document.getElementById('lineMetrics').selectedOptions)
                .map(option => option.value);
            
            const lineMetricConfig = {
                cpm: { name: 'CPM', color: '#ff7875' },
                ctr: { name: 'CTR %', color: '#95de64' },
                cpc: { name: 'CPC', color: '#ffd666' },
                convRate: { name: 'Taxa Conv %', color: '#5cdbd3' }
            };
            
            selectedLineMetrics.forEach(metric => {
                const config = lineMetricConfig[metric];
                if (config) {
                    lineSeries.push({
                        name: config.name,
                        type: 'line',
                        yAxisIndex: yAxisIndex,
                        data: processedData[metric],
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 6,
                        lineStyle: { width: 3, color: config.color },
                        itemStyle: { color: config.color },
                        emphasis: { scale: 1.5 }
                    });
                    yAxisIndex++;
                }
            });
            
            // Configurar eixos Y dinamicamente
            const yAxisConfig = [];
            const yAxisNames = [
                ...selectedBarMetrics.map(m => getMetricLabel(m)),
                ...selectedLineMetrics.map(m => lineMetricConfig[m]?.name || m)
            ];
            
            yAxisNames.forEach((name, index) => {
                const isRight = index >= selectedBarMetrics.length;
                yAxisConfig.push({
                    type: 'value',
                    name: name,
                    position: isRight ? 'right' : 'left',
                    offset: isRight ? 
                        (index - selectedBarMetrics.length) * 60 : 
                        index * 60,
                    axisLine: { show: true },
                    axisLabel: { 
                        formatter: (value) => {
                            if (name.includes('%')) return value.toFixed(1) + '%';
                            if (name.includes('$') || name.includes('Gasto') || name.includes('CPM') || name.includes('CPC')) 
                                return '$' + value.toFixed(2);
                            return value.toLocaleString('pt-BR');
                        }
                    }
                });
            });
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' }
                },
                toolbox: {
                    right: 20,
                    feature: {
                        dataZoom: { show: true },
                        restore: { show: true },
                        saveAsImage: { show: true }
                    }
                },
                legend: {
                    type: 'scroll',
                    orient: 'horizontal',
                    bottom: 10,
                    height: 40
                },
                grid: {
                    left: selectedBarMetrics.length * 70 + 20,
                    right: selectedLineMetrics.length * 70 + 20,
                    bottom: 100,
                    top: 60,
                    containLabel: false
                },
                dataZoom: [{
                    type: 'slider',
                    show: true,
                    xAxisIndex: [0],
                    start: 0,
                    end: 100,
                    bottom: 55,
                    height: 20
                }, {
                    type: 'inside',
                    xAxisIndex: [0],
                    start: 0,
                    end: 100
                }],
                xAxis: {
                    type: 'category',
                    boundaryGap: true,
                    data: processedData.dates,
                    axisLabel: {
                        rotate: 45,
                        formatter: value => {
                            const date = new Date(value);
                            return `${date.getDate()}/${date.getMonth() + 1}`;
                        }
                    }
                },
                yAxis: yAxisConfig,
                series: [...barSeries, ...lineSeries]
            };
            
            myChart.setOption(option, true);
        }
        
        // Atualizar gr√°fico
        function updateChart() {
            if (processedData.dates) {
                createChart();
            }
        }
        
        function getMetricLabel(metric) {
            const labels = {
                impressions: 'Impress√µes',
                clicks: 'Cliques',
                spend: 'Gasto ($)',
                conversions: 'Convers√µes'
            };
            return labels[metric] || metric;
        }
        
        // Auto refresh se configurado
        if (METABASE_CONFIG.chart.refreshInterval > 0) {
            setInterval(loadData, METABASE_CONFIG.chart.refreshInterval);
        }
    </script>
</body>
</html>
