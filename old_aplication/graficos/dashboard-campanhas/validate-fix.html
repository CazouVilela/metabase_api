<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valida√ß√£o da Corre√ß√£o de Filtros</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1976d2;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
        }
        .error {
            background: #ffebee;
            border-left: 4px solid #f44336;
        }
        .warning {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background: #f0f0f0;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Valida√ß√£o da Corre√ß√£o de Filtros</h1>
        
        <h2>1. Testar Estrutura dos Fieldsets</h2>
        <button onclick="analyzeFieldsets()">Analisar Fieldsets</button>
        <div id="fieldsetResults"></div>
        
        <h2>2. Simular Captura com Nova L√≥gica</h2>
        <button onclick="simulateNewCapture()">Simular Captura</button>
        <div id="captureResults"></div>
        
        <h2>3. Script de Corre√ß√£o Manual</h2>
        <p>Cole este c√≥digo no console para testar a captura manualmente:</p>
        <pre id="manualScript"></pre>
    </div>

    <script>
        // Fun√ß√£o para analisar fieldsets
        function analyzeFieldsets() {
            const results = document.getElementById('fieldsetResults');
            
            if (window.parent === window) {
                results.innerHTML = '<div class="result error">‚ùå Execute dentro do iframe no Metabase</div>';
                return;
            }
            
            try {
                const fieldsets = window.parent.document.querySelectorAll('fieldset');
                let html = `<div class="result success">‚úÖ Encontrados ${fieldsets.length} fieldsets</div>`;
                html += '<table><tr><th>#</th><th>Tem Legend?</th><th>Label/Placeholder</th><th>Valor</th><th>Classes</th></tr>';
                
                fieldsets.forEach((fieldset, index) => {
                    const legend = fieldset.querySelector('legend');
                    const valueElement = fieldset.querySelector('[role="button"], input, .lnsju');
                    
                    const hasLegend = !!legend;
                    const label = legend ? legend.textContent?.trim() : 'N/A';
                    const value = valueElement ? valueElement.textContent?.trim() || valueElement.value?.trim() : 'N/A';
                    const classes = valueElement ? valueElement.className : 'N/A';
                    
                    html += `<tr>`;
                    html += `<td>${index + 1}</td>`;
                    html += `<td>${hasLegend ? '‚úÖ Sim' : '‚ùå N√£o'}</td>`;
                    html += `<td>${hasLegend ? label : value}</td>`;
                    html += `<td>${hasLegend ? value : '(placeholder)'}</td>`;
                    html += `<td>${classes}</td>`;
                    html += `</tr>`;
                });
                
                html += '</table>';
                results.innerHTML = html;
                
            } catch (error) {
                results.innerHTML = `<div class="result error">‚ùå Erro: ${error.message}</div>`;
            }
        }
        
        // Simular nova captura
        function simulateNewCapture() {
            const results = document.getElementById('captureResults');
            
            if (window.parent === window) {
                results.innerHTML = '<div class="result error">‚ùå Execute dentro do iframe no Metabase</div>';
                return;
            }
            
            try {
                const fieldsets = window.parent.document.querySelectorAll('fieldset');
                const filters = {};
                let html = '<h3>Simula√ß√£o da Nova Captura:</h3>';
                
                fieldsets.forEach((fieldset, index) => {
                    const legend = fieldset.querySelector('legend');
                    const valueElement = fieldset.querySelector('[role="button"], input, .lnsju');
                    
                    if (!valueElement) return;
                    
                    const valueText = valueElement.textContent?.trim() || valueElement.value?.trim();
                    
                    if (legend) {
                        // Campo com valor selecionado
                        const labelText = legend.textContent?.trim();
                        const fieldName = mapFieldName(labelText);
                        
                        if (fieldName) {
                            filters[fieldName] = valueText;
                            html += `<div class="result success">‚úÖ ${labelText} ‚Üí ${fieldName} = "${valueText}"</div>`;
                        } else {
                            html += `<div class="result warning">‚ö†Ô∏è ${labelText} ‚Üí n√£o mapeado (valor: "${valueText}")</div>`;
                        }
                    } else {
                        // Campo sem valor (placeholder)
                        html += `<div class="result">‚è≠Ô∏è Placeholder ignorado: "${valueText}"</div>`;
                    }
                });
                
                html += '<h4>Filtros Capturados:</h4>';
                html += '<pre>' + JSON.stringify(filters, null, 2) + '</pre>';
                
                results.innerHTML = html;
                
            } catch (error) {
                results.innerHTML = `<div class="result error">‚ùå Erro: ${error.message}</div>`;
            }
        }
        
        // Fun√ß√£o de mapeamento (simulada)
        function mapFieldName(label) {
            const mappings = {
                'data': 'data',
                'conta': 'conta',
                'campanha': 'campanha',
                'conjunto de an√∫ncios': 'adset',
                'an√∫ncio': 'anuncio',
                'pe√ßa': 'anuncio',
                'device': 'device',
                'dispositivo': 'device',
                'plataforma': 'plataforma',
                'posi√ß√£o': 'posicao',
                'objetivo': 'objetivo',
                'buying type': 'buying_type',
                'tipo de compra': 'buying_type',
                'optimization goal': 'optimization_goal',
                'meta de otimiza√ß√£o': 'optimization_goal',
                'convers√µes consideradas': 'conversoes_consideradas'
            };
            
            const normalized = label.toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '');
            
            return mappings[normalized] || null;
        }
        
        // Script manual
        document.getElementById('manualScript').textContent = `
// Teste manual de captura de filtros
(function() {
    const fieldsets = window.parent.document.querySelectorAll('fieldset');
    const filters = {};
    
    fieldsets.forEach((fieldset, index) => {
        const legend = fieldset.querySelector('legend');
        const valueElement = fieldset.querySelector('[role="button"], input, .lnsju');
        
        if (!valueElement) return;
        
        const valueText = valueElement.textContent?.trim() || valueElement.value?.trim();
        
        if (legend) {
            const labelText = legend.textContent?.trim();
            console.log(\`Campo \${index + 1}: "\${labelText}" = "\${valueText}"\`);
            
            // Adicionar ao objeto de filtros (ajustar mapeamento conforme necess√°rio)
            const fieldName = labelText.toLowerCase().replace(/\\s+/g, '_');
            filters[fieldName] = valueText;
        } else {
            console.log(\`Campo \${index + 1}: Placeholder = "\${valueText}" (ignorado)\`);
        }
    });
    
    console.log('\\nFiltros capturados:', filters);
    return filters;
})();`;
        
        // Auto executar an√°lise se em iframe
        if (window.parent !== window) {
            setTimeout(() => {
                console.log('üîç Ferramenta de valida√ß√£o carregada. Use os bot√µes para testar.');
            }, 1000);
        }
    </script>
</body>
</html>